  
工業管理系統-延伸功能 恬依

要設計一個最萬用、最能適應未來變化且盡量減少表結構變動的員工與主管表，並涵蓋人資、機台、供應商、工單、倉庫等多種角色，最核心的策略是：

1. **統一的員工/用戶主表**：所有需要登入系統或被管理的人員都歸入一個核心的 `Employees` 表。
2. **強大的權限管理系統**：採用基於角色的權限控制（RBAC）模型，並允許對單個用戶進行權限微調。
3. **清晰的組織結構和層級關係**：透過外鍵關聯部門、職位，並支援主管層級。
4. **詳細的系統日誌**：記錄所有關鍵操作，便於審計和追蹤。

---

### **核心理念：**

- **所有人員都是“員工”**：人資、主管、機台人員、供應商人員、工單人員、倉庫人員，他們首先都是公司內部的“員工”（或與公司有緊密合作關係的外部人員，如供應商的特定聯絡人，如果他們需要登入系統）。因此，將他們統一管理在 `Employees` 表中。
- **職責透過“角色”和“權限”定義**：不同人員的職責和他們能操作的功能，完全透過權限系統來控制，而不是透過在 `Employees` 表中增加大量特定角色的欄位。
- **層級關係透過自引用實現**：主管與下屬的關係透過 `manager_id` 欄位在 `Employees` 表中實現。

---

### **最萬用的表結構設計：**

#### 1. **`Employees` 表 (員工/用戶主表)**

這是所有人員的核心資訊表。

```sql
CREATE TABLE Employees (
    employee_id INT PRIMARY KEY IDENTITY(1,1), -- 主鍵，員工唯一識別碼
    first_name NVARCHAR(50) NOT NULL,         -- 名
    last_name NVARCHAR(50) NOT NULL,          -- 姓
    employee_number NVARCHAR(20) UNIQUE NOT NULL, -- 員工編號，唯一，便於內部管理
    
    -- 個人資料
    birth_date DATE NULL,                     -- 出生日期
    email NVARCHAR(100) UNIQUE NULL,          -- 電子郵件，唯一，可用於登入或聯絡
    phone NVARCHAR(20) NULL,                  -- 電話
    photo_path NVARCHAR(255) NULL,            -- 照片儲存路徑
    
    -- 組織結構與層級
    department_id INT NULL,                   -- 所屬部門ID，關聯 Departments 表
    position_id INT NULL,                     -- 職位ID，關聯 Positions 表
    manager_id INT NULL,                      -- 直接上級員工ID，自引用 Employees 表，用於建構層級關係
    
    hire_date DATE NULL,                      -- 入職日期
    termination_date DATE NULL,               -- 離職日期
    
    -- 系統登入相關
    username NVARCHAR(50) UNIQUE NULL,        -- 員工登入帳號，唯一
    password_hash NVARCHAR(255) NULL,         -- 員工登入密碼的哈希值（推薦使用哈希，而非明文密碼）
    is_active BIT DEFAULT 1,                  -- 是否活躍/可登入/在職 (1=是, 0=否)
    last_login DATETIME2 NULL,                -- 最後登入時間
    
    created_at DATETIME2 DEFAULT GETDATE(),   -- 記錄建立時間
    updated_at DATETIME2 DEFAULT GETDATE()   -- 記錄最後更新時間

    -- 外鍵約束
    FOREIGN KEY (department_id) REFERENCES Departments(department_id),
    FOREIGN KEY (position_id) REFERENCES Positions(position_id),
    FOREIGN KEY (manager_id) REFERENCES Employees(employee_id) -- 自引用外鍵
);

-- 唯一性約束
ALTER TABLE Employees ADD CONSTRAINT uk_emp_username UNIQUE (username);
ALTER TABLE Employees ADD CONSTRAINT uk_emp_email UNIQUE (email);
ALTER TABLE Employees ADD CONSTRAINT uk_emp_employee_number UNIQUE (employee_number);
```

#### 2. **`Departments` 表 (部門資訊)**

```sql
CREATE TABLE Departments (
    department_id INT PRIMARY KEY IDENTITY(1,1),
    department_name NVARCHAR(100) UNIQUE NOT NULL, -- 部門名稱，唯一
    description TEXT NULL,                          -- 部門描述
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE()
);
```

#### 3. **`Positions` 表 (職位資訊)**

```sql
CREATE TABLE Positions (
    position_id INT PRIMARY KEY IDENTITY(1,1),
    position_name NVARCHAR(100) UNIQUE NOT NULL,   -- 職位名稱，唯一
    description TEXT NULL,                          -- 職位描述
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE()
);
```

#### 4. **`Permissions` 表 (權限定義)**

定義系統中所有可授予的權限。

```sql
CREATE TABLE Permissions (
    id INT IDENTITY(1,1) PRIMARY KEY,
    permission_code VARCHAR(50) UNIQUE NOT NULL,  -- 權限代碼：EMPLOYEE_VIEW, MACHINE_MANAGE, SUPPLIER_VIEW等
    permission_name VARCHAR(100) NOT NULL,        -- 權限名稱（中文描述）
    description TEXT,                             -- 權限詳細描述
    module VARCHAR(50) NOT NULL,                  -- 所屬模組：PERSONNEL, SYSTEM, EQUIPMENT, SUPPLIER, INVENTORY, PRODUCTION等
    is_active BIT DEFAULT 1,                      -- 是否啟用此權限
    created_at DATETIME2 DEFAULT GETDATE()
);
```

#### 5. **`Roles` 表 (角色定義)**

定義系統中的各種角色，如“人資主管”、“機台操作員”、“倉庫管理員”等。

```sql
CREATE TABLE Roles (
    role_id INT IDENTITY(1,1) PRIMARY KEY,
    role_name VARCHAR(50) UNIQUE NOT NULL,        -- 角色名稱：admin, hr_manager, machine_operator, supplier_personnel, warehouse_staff, production_planner等
    description TEXT,                             -- 角色描述
    created_at DATETIME2 DEFAULT GETDATE()
);
```

#### 6. **`UserRoles` 表 (用戶-角色關聯)**

一個員工可以擁有多個角色。

```sql
CREATE TABLE UserRoles (
    id INT IDENTITY(1,1) PRIMARY KEY,
    employee_id INT NOT NULL,                     -- 關聯 Employees 表
    role_id INT NOT NULL,                         -- 關聯 Roles 表
    assigned_by NVARCHAR(50),                     -- 誰分配的（可以是操作者用戶名）
    assigned_at DATETIME2 DEFAULT GETDATE(),      -- 分配時間
    
    FOREIGN KEY (employee_id) REFERENCES Employees(employee_id),
    FOREIGN KEY (role_id) REFERENCES Roles(role_id),
    UNIQUE(employee_id, role_id) -- 確保一個員工不會重複擁有同一個角色
);
```

#### 7. **`RolePermissions` 表 (角色-權限關聯)**

定義每個角色擁有哪些權限。

```sql
CREATE TABLE RolePermissions (
    id INT IDENTITY(1,1) PRIMARY KEY,
    role_id INT NOT NULL,                        -- 關聯 Roles 表
    permission_code VARCHAR(50) NOT NULL,        -- 關聯 Permissions 表的權限代碼
    granted_by NVARCHAR(50),                     -- 授權者
    granted_at DATETIME2 DEFAULT GETDATE(),      -- 授權時間
    
    FOREIGN KEY (role_id) REFERENCES Roles(role_id),
    FOREIGN KEY (permission_code) REFERENCES Permissions(permission_code),
    UNIQUE(role_id, permission_code) -- 確保一個角色不會重複擁有同一個權限
);
```

#### 8. **`UserPermissions` 表 (用戶額外權限)**

用於處理個別用戶權限的特殊情況（授予或撤銷某個角色之外的權限）。

```sql
CREATE TABLE UserPermissions (
    id INT IDENTITY(1,1) PRIMARY KEY,
    employee_id INT NOT NULL,                     -- 關聯 Employees 表
    permission_code VARCHAR(50) NOT NULL,         -- 關聯 Permissions 表的權限代碼
    is_granted BIT NOT NULL,                      -- 1=授予，0=撤銷（覆蓋角色權限）
    granted_by NVARCHAR(50),                      -- 授權者
    granted_at DATETIME2 DEFAULT GETDATE(),       -- 授權時間
    reason TEXT,                                  -- 授權/撤銷原因
    
    FOREIGN KEY (employee_id) REFERENCES Employees(employee_id),
    FOREIGN KEY (permission_code) REFERENCES Permissions(permission_code),
    UNIQUE(employee_id, permission_code) -- 確保一個員工不會重複設定同一個權限
);
```

#### 9. **`SystemLogs` 表 (系統操作日誌)**

詳細記錄所有關鍵操作，便於審計和問題追蹤。

```sql
CREATE TABLE SystemLogs (
    id INT IDENTITY(1,1) PRIMARY KEY,
    log_type VARCHAR(50) NOT NULL,           -- 日誌類型：LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT等
    operation VARCHAR(100) NOT NULL,         -- 操作描述：ADD_EMPLOYEE, UPDATE_USER_PASSWORD, APPROVE_WORKORDER等
    operator_employee_id INT NULL,           -- 操作者員工ID (關聯 Employees 表)
    operator_username NVARCHAR(50) NOT NULL, -- 操作者用戶名 (冗餘欄位，方便查詢和日誌記錄)
    target_type VARCHAR(50),                 -- 目標類型：EMPLOYEE, USER, MACHINE, SUPPLIER, WORKORDER, INVENTORY等  
    target_id NVARCHAR(50),                  -- 目標ID或識別碼（可以是字串，如員工編號、工單號）
    target_name NVARCHAR(100),               -- 目標名稱（如員工姓名、設備名稱）
    old_value TEXT,                          -- 修改前的值（JSON格式，用於記錄資料變更）
    new_value TEXT,                          -- 修改後的值（JSON格式）
    description TEXT,                        -- 詳細描述（如「管理員A修改了員工B的電話號碼」）
    ip_address VARCHAR(45),                  -- 操作者IP地址
    user_agent VARCHAR(500),                 -- 瀏覽器/客戶端資訊
    created_at DATETIME2 DEFAULT GETDATE(),  -- 記錄建立時間
    module VARCHAR(50)                       -- 所屬模組：PERSONNEL, SYSTEM, EQUIPMENT, SUPPLIER, INVENTORY, PRODUCTION等
    
    FOREIGN KEY (operator_employee_id) REFERENCES Employees(employee_id)
);

-- 建立常用查詢索引
CREATE INDEX idx_logs_operator_id ON SystemLogs(operator_employee_id);
CREATE INDEX idx_logs_created_at ON SystemLogs(created_at);
CREATE INDEX idx_logs_log_type ON SystemLogs(log_type);
CREATE INDEX idx_logs_target_type ON SystemLogs(target_type);
CREATE INDEX idx_logs_module ON SystemLogs(module);
```


功能: 工業管理系統員工管理
登入頁面
管理員工頁面
使用者權限控管
儀錶板偵測人數和方便入口
日誌檔紀錄

然後根據權限控管sidebar的 元件顯示 與操作
然後在sidebar也能點進去查看個人資料 同理 header也是

在controller 使用swagger去控管
用spring secrity 